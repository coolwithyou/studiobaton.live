generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// 사용자 역할
enum UserRole {
  ADMIN       // 최고 관리자 - 모든 페이지 접근
  TEAM_MEMBER // 개발팀원 - 커밋 리뷰만 접근
  ORG_MEMBER  // 바토너 - 어드민 접근 불가, 마스킹 해제만
}

// 사용자 상태
enum UserStatus {
  PENDING  // 승인 대기
  ACTIVE   // 활성
  INACTIVE // 비활성
}

model Admin {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // 역할 기반 접근 제어
  role          UserRole   @default(ORG_MEMBER)
  status        UserStatus @default(PENDING)
  approvedBy    String?    // 승인한 관리자 ID
  approvedAt    DateTime?  // 승인 일시

  // Member 연결 (이메일 자동 매칭)
  linkedMemberId String?  @unique
  linkedMember   Member?  @relation(fields: [linkedMemberId], references: [id], onDelete: SetNull)

  authoredPosts  Post[]   @relation("PostAuthor")
  publishedPosts Post[]   @relation("PostPublisher")
  accounts       Account[]
  sessions       Session[]
}

model CommitLog {
  id           String   @id @default(cuid())
  sha          String   @unique
  repository   String
  message      String
  author       String
  authorEmail  String?
  authorAvatar String?
  committedAt  DateTime
  additions    Int      @default(0)
  deletions    Int      @default(0)
  filesChanged Int      @default(0)
  url          String

  createdAt    DateTime @default(now())

  post         Post?    @relation(fields: [postId], references: [id])
  postId       String?

  files        CommitFile[]

  @@index([committedAt])
  @@index([repository])
}

model CommitFile {
  id        String    @id @default(cuid())
  commit    CommitLog @relation(fields: [commitSha], references: [sha], onDelete: Cascade)
  commitSha String
  filename  String
  status    String    // added | modified | removed | renamed
  additions Int       @default(0)
  deletions Int       @default(0)
  changes   Int       @default(0)
  patch     String?   @db.Text
  createdAt DateTime  @default(now())

  @@index([commitSha])
}

model Post {
  id            String        @id @default(cuid())
  targetDate    DateTime
  status        PostStatus    @default(DRAFT)

  // 포스트 타입 및 카테고리
  type          PostType      @default(COMMIT_BASED)
  category      String?       // 카테고리 (사이드 메뉴 연동용)
  showInTimeline Boolean      @default(false) // MANUAL 타입 포스트의 타임라인 노출 여부

  title         String?
  content       String?
  summary       String?

  versions      PostVersion[]
  commits       CommitLog[]

  // 작성자
  author        Admin?        @relation("PostAuthor", fields: [authorId], references: [id])
  authorId      String?

  // 발행자
  publishedAt   DateTime?
  publishedBy   Admin?        @relation("PostPublisher", fields: [publishedById], references: [id])
  publishedById String?

  slug          String?       @unique

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([targetDate])
  @@index([status])
  @@index([publishedAt])
  @@index([type])
  @@index([category])
}

model PostVersion {
  id            String      @id @default(cuid())
  post          Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId        String

  version       Int
  title         String
  content       String
  summary       String?
  suggestedSlug String?     // AI가 제안한 SEO 친화적 영문 slug
  tone          VersionTone

  isSelected    Boolean     @default(false)

  createdAt     DateTime    @default(now())

  @@unique([postId, version])
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum VersionTone {
  PROFESSIONAL
  CASUAL
  TECHNICAL
}

// 포스트 타입
enum PostType {
  COMMIT_BASED // 기존: 커밋 기반 자동 생성
  MANUAL       // 신규: 수동 마크다운 포스트
}

// 사이드 메뉴 아이템 링크 타입
enum LinkType {
  INTERNAL      // 내부 페이지
  EXTERNAL      // 외부 링크
  POST_CATEGORY // 카테고리별 포스트 목록
}

// GitHub 리포지토리 캐시 (수동 동기화)
model Repository {
  id          String   @id @default(cuid())
  name        String   @unique // GitHub 리포지토리명
  description String?          // GitHub 설명
  isPrivate   Boolean  @default(false)
  url         String?
  isDeleted   Boolean  @default(false) // GitHub에서 삭제됨
  syncedAt    DateTime @default(now()) // 마지막 동기화 시간
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProjectMapping {
  id             String   @id @default(cuid())
  repositoryName String   @unique // GitHub 리포지토리 이름 (예: "kiaf.web")
  displayName    String   // 표시할 프로젝트 명 (예: "Kiaf SEOUL")
  maskName       String?  // 비로그인 시 표시할 마스킹명 (예: "고객사 A")
  description    String?  // 프로젝트 설명 (선택)
  isActive       Boolean  @default(true) // 활성화 여부 (글 생성에 포함할지)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Member {
  id              String   @id @default(cuid())
  name            String   // 팀원 이름 (예: "홍길동")
  githubName      String   // GitHub 사용자명
  email           String   @unique // GitHub 커밋 이메일 (CommitLog.authorEmail과 매칭)
  avatarUrl       String?  // 1:1 아바타 (포스트, 헤더, 멤버 카드)
  profileImageUrl String?  // 3:4 프로필 이미지 (프로필 페이지)
  bio             String?  @db.Text // 자기소개 (줄바꿈 지원)
  title           String?  // 직함 (예: "시니어 개발자")
  role            String?  // 역할 (예: "프론트엔드 리드")
  isActive        Boolean  @default(true) // 활성화 여부
  displayOrder    Int      @default(0) // 탭 표시 순서

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  standups         Standup[]
  commitSummaries  CommitSummary[]
  linkedAdmin      Admin?    // Admin 연결 (역관계)
  dailyActivities  MemberDailyActivity[]
  profileStats     MemberProfileStats?

  @@index([isActive])
  @@index([displayOrder])
}

// AI 커밋 하이라이트 요약 (팀원별 일일)
model CommitSummary {
  id             String            @id @default(cuid())
  memberId       String
  member         Member            @relation(fields: [memberId], references: [id], onDelete: Cascade)
  date           DateTime          @db.Date
  totalCommits   Int               @default(0)
  highlightCount Int               @default(0)
  primaryFocus   String            // 주요 작업 요약
  techDebtNotes  String[]          // 기술 부채 노트 배열
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  highlights     CommitHighlight[]

  @@unique([memberId, date])
  @@index([date])
  @@index([memberId])
}

// AI 커밋 하이라이트 개별 항목
model CommitHighlight {
  id          String        @id @default(cuid())
  summaryId   String
  summary     CommitSummary @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  rank        Int           // 순위 (1, 2, 3...)
  commitHash  String        // 커밋 SHA (짧은 버전)
  category    String        // feat, fix, perf, refactor, test, chore
  title       String        // 제목
  description String        // 설명
  impact      String        // 영향도
  createdAt   DateTime      @default(now())

  @@index([summaryId])
}

// 스탠드업 (팀원별 일일 할 일)
model Standup {
  id        String        @id @default(cuid())
  memberId  String
  member    Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  date      DateTime      @db.Date
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  tasks     StandupTask[]

  @@unique([memberId, date])
  @@index([date])
  @@index([memberId])
}

// 스탠드업 할 일 항목
model StandupTask {
  id              String    @id @default(cuid())
  standupId       String
  standup         Standup   @relation(fields: [standupId], references: [id], onDelete: Cascade)
  content         String    // 할 일 내용 (@mention 포함 가능)
  repository      String?   // 참조된 레포 (예: studiobaton/kiaf.web)
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?
  displayOrder    Int       @default(0)

  // 날짜 관리 (캐리오버 & 미래 예약)
  dueDate         DateTime  @db.Date  // 목표 완료 날짜 (리스케줄 가능)
  originalDueDate DateTime  @db.Date  // 최초 작성 날짜 (불변, 뱃지 표시용)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([standupId])
  @@index([dueDate])
  @@index([isCompleted, dueDate])
}

// Auth.js required models
model Account {
  id                String  @id @default(cuid())
  adminId           String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([adminId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  adminId      String
  expires      DateTime

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// 멤버별 일일 활동 집계 (프로필 통계용 캐싱 테이블)
model MemberDailyActivity {
  id       String   @id @default(cuid())
  memberId String
  member   Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  date     DateTime @db.Date

  // 일일 커밋 통계
  commitCount  Int @default(0)
  additions    Int @default(0)
  deletions    Int @default(0)
  filesChanged Int @default(0)

  // 저장소별 커밋 분포 { "repo1": 5, "repo2": 3 }
  repoBreakdown Json?

  // 시간대별 커밋 분포 (24시간, 0-23시)
  hourlyDistribution Int[] @default([])

  // 커밋 유형별 카운트 (메시지에서 파싱)
  featCount     Int @default(0)
  fixCount      Int @default(0)
  refactorCount Int @default(0)
  otherCount    Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, date])
  @@index([memberId])
  @@index([date])
}

// 멤버 프로필 통계 (집계 캐시)
model MemberProfileStats {
  id       String @id @default(cuid())
  memberId String @unique
  member   Member @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // 전체 커밋 통계
  totalCommits   Int @default(0)
  totalAdditions Int @default(0)
  totalDeletions Int @default(0)

  // 활동 기간
  firstCommitAt DateTime?
  lastCommitAt  DateTime?

  // 스트릭 정보
  currentStreak Int @default(0) // 현재 연속 커밋 일수
  longestStreak Int @default(0) // 최장 연속 커밋 일수

  // 활동 패턴
  peakHour   Int? // 가장 활발한 시간 (0-23)
  activeDays Int  @default(0) // 총 활동 일수

  // 획득 배지 ["first_commit", "streak_7", "commits_100", ...]
  badges Json?

  // 마지막 집계 시점
  lastAggregatedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 커밋 수집 로그 (레포+월 단위 수집 추적)
model CommitCollectionLog {
  id          String   @id @default(cuid())
  repository  String   // 레포지토리 이름
  monthKey    String   // "2024-01" 형식
  status      String   @default("completed") // completed | partial | error
  commitCount Int      @default(0) // 해당 기간에 수집된 커밋 수
  errorMessage String? // 에러 발생 시 메시지
  collectedAt DateTime @default(now())

  @@unique([repository, monthKey])
  @@index([repository])
  @@index([monthKey])
}

// 사이드 메뉴 섹션 (ABOUT US 같은 최상위 메뉴)
model SideMenuSection {
  id           String         @id @default(cuid())
  title        String         // "ABOUT US"
  displayOrder Int            @default(0)
  isActive     Boolean        @default(true)

  items        SideMenuItem[]

  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([displayOrder])
  @@index([isActive])
}

// 사이드 메뉴 아이템 (하위 메뉴)
model SideMenuItem {
  id           String           @id @default(cuid())
  sectionId    String
  section      SideMenuSection  @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  title        String           // "BATON DEV", "TMI"
  displayOrder Int              @default(0)
  isActive     Boolean          @default(true)

  linkType     LinkType         @default(INTERNAL)
  internalPath String?          // 내부 경로: "/posts?category=dev"
  externalUrl  String?          // 외부 URL
  postCategory String?          // Post.category와 매핑

  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@index([sectionId])
  @@index([displayOrder])
}
