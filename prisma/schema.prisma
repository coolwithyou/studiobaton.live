generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// 사용자 역할
enum UserRole {
  ADMIN       // 최고 관리자 - 모든 페이지 접근
  TEAM_MEMBER // 개발팀원 - 커밋 리뷰만 접근
  ORG_MEMBER  // 바토너 - 어드민 접근 불가, 마스킹 해제만
}

// 사용자 상태
enum UserStatus {
  PENDING  // 승인 대기
  ACTIVE   // 활성
  INACTIVE // 비활성
}

model Admin {
  id            String     @id @default(cuid())
  email         String     @unique
  name          String?
  image         String?
  emailVerified DateTime?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // 역할 기반 접근 제어
  role          UserRole   @default(ORG_MEMBER)
  status        UserStatus @default(PENDING)
  approvedBy    String?    // 승인한 관리자 ID
  approvedAt    DateTime?  // 승인 일시

  publishedPosts Post[]
  accounts       Account[]
  sessions       Session[]
}

model CommitLog {
  id           String   @id @default(cuid())
  sha          String   @unique
  repository   String
  message      String
  author       String
  authorEmail  String?
  authorAvatar String?
  committedAt  DateTime
  additions    Int      @default(0)
  deletions    Int      @default(0)
  filesChanged Int      @default(0)
  url          String

  createdAt    DateTime @default(now())

  post         Post?    @relation(fields: [postId], references: [id])
  postId       String?

  files        CommitFile[]

  @@index([committedAt])
  @@index([repository])
}

model CommitFile {
  id        String    @id @default(cuid())
  commit    CommitLog @relation(fields: [commitSha], references: [sha], onDelete: Cascade)
  commitSha String
  filename  String
  status    String    // added | modified | removed | renamed
  additions Int       @default(0)
  deletions Int       @default(0)
  changes   Int       @default(0)
  patch     String?   @db.Text
  createdAt DateTime  @default(now())

  @@index([commitSha])
}

model Post {
  id            String        @id @default(cuid())
  targetDate    DateTime
  status        PostStatus    @default(DRAFT)

  title         String?
  content       String?
  summary       String?

  versions      PostVersion[]
  commits       CommitLog[]

  publishedAt   DateTime?
  publishedBy   Admin?        @relation(fields: [publishedById], references: [id])
  publishedById String?

  slug          String?       @unique

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@index([targetDate])
  @@index([status])
  @@index([publishedAt])
}

model PostVersion {
  id         String      @id @default(cuid())
  post       Post        @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId     String

  version    Int
  title      String
  content    String
  summary    String?
  tone       VersionTone

  isSelected Boolean     @default(false)

  createdAt  DateTime    @default(now())

  @@unique([postId, version])
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum VersionTone {
  PROFESSIONAL
  CASUAL
  TECHNICAL
}

model ProjectMapping {
  id             String   @id @default(cuid())
  repositoryName String   @unique // GitHub 리포지토리 이름 (예: "kiaf.web")
  displayName    String   // 표시할 프로젝트 명 (예: "Kiaf SEOUL")
  maskName       String?  // 비로그인 시 표시할 마스킹명 (예: "고객사 A")
  description    String?  // 프로젝트 설명 (선택)
  isActive       Boolean  @default(true) // 활성화 여부 (글 생성에 포함할지)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Member {
  id           String   @id @default(cuid())
  name         String   // 팀원 이름 (예: "홍길동")
  githubName   String   // GitHub 사용자명
  email        String   @unique // GitHub 커밋 이메일 (CommitLog.authorEmail과 매칭)
  avatarUrl    String?  // 프로필 이미지 URL
  isActive     Boolean  @default(true) // 활성화 여부
  displayOrder Int      @default(0) // 탭 표시 순서

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([displayOrder])
}

// Auth.js required models
model Account {
  id                String  @id @default(cuid())
  adminId           String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([adminId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  adminId      String
  expires      DateTime

  admin Admin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
